<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wadi Moughanim</title>
<style>
  :root{--bg:#0e1116;--ink:#f2f5f7;--card:#12161b;--edge:#222a35;--up:#56d17a;--dn:#ff6b6b}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#0b0e13 0%, var(--bg) 100%);
    color:var(--ink);font:400 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    display:flex;align-items:center;justify-content:center;padding:24px
  }
  .wrap{width:min(860px,94vw)}
  h1{margin:0 0 4px;font-size:clamp(26px,4vw,40px);text-align:center;letter-spacing:.2px}
  .pnl{margin:2px 0 10px;text-align:center;font-weight:700;color:#cfe6ff}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:12px;
        box-shadow:0 18px 40px rgba(0,0,0,.35); margin-bottom:16px}
  #chart{display:block;width:100%;height:420px;border-radius:10px;background:#0c1118}
  .row{display:flex;gap:10px;justify-content:center;margin:12px 0 2px}
  button{cursor:pointer;border:1px solid var(--edge);background:#0f1520;color:var(--ink);
         padding:10px 18px;border-radius:12px;font-weight:700;letter-spacing:.2px}
  button:active{transform:translateY(1px)}
  .pos{margin:6px 0 2px;text-align:center;font-weight:700;color:#9fb7ff}
  .about{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;
         box-shadow:0 18px 40px rgba(0,0,0,.35)}
  .about h2{margin:0 0 10px;text-align:center;font-size:18px;opacity:.9}
  .about p{margin:.25rem 0 1rem;opacity:.85}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Wadi Moughanim</h1>
    <div class="pnl">PnL: <span id="pnl">0.00</span></div>

    <div class="card">
      <canvas id="chart"></canvas>
      <div class="row">
        <button id="decBtn">−</button>
        <button id="incBtn">+</button>
      </div>
      <div class="pos">Position: <span id="pos">0</span></div>
    </div>

  </div>

<script>
(function(){
  // ===== Parameters =====
  const dtMs = 150;
  const halfSec = (500/dtMs)|0;
  const candleTicks = halfSec;

  // organic log-price dynamics
  const baseSigma = 0.003;   // base vol per tick (log space)
  const volK = 0.20;         // +vol per |pos|
  const impactK = 0.0016;    // adverse drift per unit
  const kappa = 0.00025;     // gentle pull to anchor
  const clampMin = 1;
  const maxCandles = 240;

  // ===== State =====
  let S = 100, logS = Math.log(S);
  let pos = 0, avg = 0, realized = 0;
  let tick = 0, sub = 0;
  let rPrev = 0, vState = 0; // AR + vol clustering

  // candles
  let O=[],H=[],L=[],C=[],X=[];
  let curO=S,curH=S,curL=S,curC=S;

  // UI
  const pnlEl = document.getElementById('pnl');
  const posEl = document.getElementById('pos');
  const incBtn = document.getElementById('incBtn');
  const decBtn = document.getElementById('decBtn');

  // canvas
  const canvas = document.getElementById('chart'), ctx = canvas.getContext('2d');
  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    canvas.width  = Math.floor(canvas.clientWidth * dpr);
    canvas.height = Math.floor(canvas.clientHeight* dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function pushCandle(o,h,l,c,i){
    O.push(o);H.push(h);L.push(l);C.push(c);X.push(i);
    if(O.length>maxCandles){O.shift();H.shift();L.shift();C.shift();X.shift();}
  }
  function updateLast(h,l,c){
    H[H.length-1] = Math.max(H[H.length-1], h);
    L[L.length-1] = Math.min(L[L.length-1], l);
    C[C.length-1] = c;
  }
  function initCandles(n=30){ for(let i=0;i<n;i++) pushCandle(S,S,S,S,i); }
  resize(); addEventListener('resize', ()=>{ resize(); draw(); }); initCandles();

  // rng
  function randn(){ const u=Math.random(),v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }

  function stepPrice(){
    const anchor = Math.log(100);
    // adverse drift against position + gentle mean reversion
    const drift = -impactK*pos + kappa*(anchor - logS);
    const z = randn();
    // volatility clustering: vState carries shock magnitude
    vState = 0.92*vState + 0.08*Math.abs(z);
    const sigma = baseSigma*(1 + volK*Math.abs(pos))*(1 + 0.8*vState);
    // AR(1) return for smoother “organic” swings
    const r = 0.80*rPrev + sigma*z;
    rPrev = r;

    logS += drift + r;
    S = Math.max(clampMin, Math.exp(logS));
  }

  function mtm(){ return realized + pos*(S - avg); }

  function changePos(delta){
    const target = Math.max(-10, Math.min(10, pos + delta));
    let rem = target - pos;
    while(rem !== 0){
      const step = rem > 0 ? 1 : -1;
      if(pos === 0 || Math.sign(pos) === Math.sign(step)){
        const oldQty = Math.abs(pos), newQty = oldQty + 1;
        avg = (avg*oldQty + S) / newQty;
        pos += step;
      } else {
        realized += (S - avg) * Math.sign(pos);
        pos += step;
        if(pos === 0) avg = 0;
      }
      rem -= step;
    }
    posEl.textContent = pos.toString();
    // little volatility kick on interaction
    rPrev *= 0.3; vState += 0.6;
  }

  incBtn.onclick = ()=> changePos(+1);
  decBtn.onclick = ()=> changePos(-1);
  addEventListener('keydown', e=>{
    if(e.key==='ArrowRight' || e.key==='+') changePos(+1);
    if(e.key==='ArrowLeft'  || e.key==='-') changePos(-1);
  });

  function draw(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    ctx.clearRect(0,0,w,h);
    if(!O.length) return;

    const lo = Math.min(...L), hi = Math.max(...H);
    const pad = (hi-lo)*0.05 || 1;
    const yMin = lo - pad, yMax = hi + pad;
    const yScale = v => h - ((v - yMin)/(yMax - yMin))*(h-12) - 6;

    const n = O.length;
    const gap = Math.max(3, w/n);
    const body = Math.max(2, gap*0.55);

    // candles
    for(let i=0;i<n;i++){
      const x = i*gap + gap*0.2;
      const yO=yScale(O[i]), yC=yScale(C[i]), yH=yScale(H[i]), yL=yScale(L[i]);
      const up = C[i] >= O[i];
      ctx.strokeStyle = up ? '#56d17a' : '#ff6b6b';
      ctx.fillStyle   = ctx.strokeStyle;
      // wick
      ctx.beginPath(); ctx.moveTo(x+body/2, yH); ctx.lineTo(x+body/2, yL); ctx.stroke();
      // body
      const top = Math.min(yO,yC), ht = Math.max(1, Math.abs(yC - yO));
      ctx.globalAlpha=.9; ctx.fillRect(x, top, body, ht); ctx.globalAlpha=1;
    }

    // last price tag on the right
    const yLast = yScale(C[n-1]);
    ctx.strokeStyle = 'rgba(200,220,255,.25)';
    ctx.setLineDash([4,6]); ctx.beginPath(); ctx.moveTo(0, yLast); ctx.lineTo(w, yLast); ctx.stroke(); ctx.setLineDash([]);

    const label = C[n-1].toFixed(2);
    ctx.font = '700 13px Inter,system-ui,sans-serif';
    const tw = ctx.measureText(label).width;
    const padX = 8, padY = 4, boxW = tw + padX*2, boxH = 24;
    const xBox = w - boxW - 6, yBox = Math.max(6, Math.min(h - boxH - 6, yLast - boxH/2));
    ctx.fillStyle = '#1a2433'; ctx.strokeStyle = '#2a3a55';
    const r=8;
    ctx.beginPath();
    ctx.moveTo(xBox+r,yBox);
    ctx.arcTo(xBox+boxW,yBox,xBox+boxW,yBox+boxH,r);
    ctx.arcTo(xBox+boxW,yBox+boxH,xBox,yBox+boxH,r);
    ctx.arcTo(xBox,yBox+boxH,xBox,yBox,r);
    ctx.arcTo(xBox,yBox,xBox+boxW,yBox,r);
    ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#cfe6ff';
    ctx.fillText(label, xBox + padX, yBox + boxH - padY - 6);
  }

  // engine
  setInterval(()=>{
    tick++; sub++;
    stepPrice();

    if(sub % candleTicks === 1){
      curO = curH = curL = curC = S;
      pushCandle(curO,curH,curL,curC, tick/candleTicks);
    } else {
      curH = Math.max(curH, S);
      curL = Math.min(curL, S);
      curC = S;
      updateLast(curH,curL,curC);
    }

    if(sub % halfSec === 0){
      pnlEl.textContent = mtm().toFixed(2);
    }

    draw();
  }, dtMs);
})();
</script>
</body>
</html>
